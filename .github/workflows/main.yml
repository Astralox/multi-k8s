on: [push]

name: Run Azure Login With a Service Principal Secret

jobs:

  build-and-test:
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
    - name: Docker Login
      uses: docker/login-action@v3.3.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker build & test client
      uses: actions/checkout@v4

    - name: Test
      run: |-
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker build -t astralox/multi-client -f ./client/Dockerfile.dev ./client
        docker run -e CI=true astralox/multi-client npm test

  build:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      - uses: actions/checkout@v4
      
      - uses: Azure/docker-login@v1
        with:
          login-server: hub.docker.com
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - run: |-
          docker build -t astralox/multi-client-k8s-gh:latest -t astralox/multi-client-k8s-gh:${{ github.sha }} -f ./client/Dockerfile ./client
          docker build -t astralox/multi-server-k8s-gh:latest -t astralox/multi-server-k8s-gh:${{ github.sha }} -f ./server/Dockerfile ./server
          docker build -t astralox/multi-worker-k8s-gh:latest -t astralox/multi-worker-k8s-gh:${{ github.sha }} -f ./worker/Dockerfile ./worker
          docker push astralox/multi-client-k8s-gh:latest
          docker push astralox/multi-server-k8s-gh:latest
          docker push astralox/multi-worker-k8s-gh:latest
          docker push astralox/multi-client-k8s-gh:${{ github.sha }}
          docker push astralox/multi-server-k8s-gh:${{ github.sha }}
          docker push astralox/multi-worker-k8s-gh:${{ github.sha }}
          
      - uses: azure/setup-kubectl@v4
      
      # Set the target AKS cluster.
      - uses: Azure/aks-set-context@v4
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          cluster-name: multi-k8s-dal
          resource-group: multi-k8s-dal
      
      - uses: Azure/k8s-deploy@v5
        with:
          action: deploy
          manifests: |
            k8s
          images: |-
            hub.docker.com/astralox/multi-client:${{ github.sha }}
            hub.docker.com/astralox/multi-server:${{ github.sha }}
            hub.docker.com/astralox/multi-worker:${{ github.sha }}
