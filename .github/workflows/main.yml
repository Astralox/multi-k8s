on: [push]

name: Run Azure Login With a Service Principal Secret

jobs:

  build-and-test:
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
    - name: Docker Login
      uses: docker/login-action@v3.3.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker build & test client
      uses: actions/checkout@v4

    - name: Test
      run: |-
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker build -t astralox/multi-client -f ./client/Dockerfile.dev ./client
        docker run -e CI=true astralox/multi-client npm test

  build:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push client
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          file: "client"
          tags: |
            astralox/multi-client-k8s-gh:latest
            astralox/multi-client-k8s-gh:${{ github.sha }}
            
      - name: Build and push server
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          file: "server"
          tags: |
            astralox/multi-server-k8s-gh:latest
            astralox/multi-server-k8s-gh:${{ github.sha }}

      - name: Build and push worker
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          file: "worker"
          tags: |
            astralox/multi-worker-k8s-gh:latest
            astralox/multi-worker-k8s-gh:${{ github.sha }}
            
          
      - uses: azure/setup-kubectl@v4
      
      # Set the target AKS cluster.
      - uses: Azure/aks-set-context@v4
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          cluster-name: multi-k8s-dal
          resource-group: multi-k8s-dal
      
      - uses: Azure/k8s-deploy@v5
        with:
          action: deploy
          manifests: |
            k8s
          images: |-
            hub.docker.com/astralox/multi-client:${{ github.sha }}
            hub.docker.com/astralox/multi-server:${{ github.sha }}
            hub.docker.com/astralox/multi-worker:${{ github.sha }}
